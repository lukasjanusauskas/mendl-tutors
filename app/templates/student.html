{% extends "base.html" %}

{% if session.session_type == 'admin' %}
{% set back_url = url_for('students') %}
{% elif session.session_type == 'student' %}
{% set back_url = url_for('index') %}
{% endif %}

{% block title %}PerÅ¾iÅ«ra: {{ student.first_name }} {{ student.last_name }}{% endblock %}

{% block content %}
<div class="container py-5">

    {% if error %}
        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            {{ error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    {% if student %}

        <!-- Student Info -->
        <div class="card border-0 shadow-sm rounded-4 mb-5 p-5">
            <div class="d-flex align-items-center mb-4">
                <div class="me-3">
                    <i class="bi bi-person-circle fs-1 text-success"></i>
                </div>
                <div>
                    <h1 class="h3 mb-1">{{ student.first_name }} {{ student.second_name or "" }} {{ student.last_name }}</h1>
                    <p class="mb-1"><i class="bi bi-envelope"></i> {{ student.student_email or "-" }}</p>
                    <p class="mb-0"><i class="bi bi-telephone"></i> {{ student.student_phone_number or "-" }}</p>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4"><strong>Gimimo data:</strong> {{ student.date_of_birth.strftime('%Y-%m-%d') if student.date_of_birth else '-' }}</div>
                <div class="col-md-4"><strong>KlasÄ—:</strong> {{ student.class or '-' }}</div>
                <div class="col-md-4"><strong>TÄ—vÅ³ el. paÅ¡tas:</strong> {{ student.parents_email or '-' }}</div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4"><strong>TÄ—vÅ³ telefonai:</strong> {{ student.parents_phone_numbers | join(', ') or '-' }}</div>
                <div class="col-md-4">
                    <strong>Dalykai:</strong>
                    {% if student.subjects %}
                        {{ student.subjects | join(', ') }}
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div class="col-md-4"><strong>MokÄ—ti Å¡Ä¯ mÄ—nesÄ¯:</strong> {{ student.pay or '-'}}</div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <strong>AtsiliepimÅ³ skaiÄius:</strong>
                    <span class="badge bg-success rounded-pill">{{ student.review_count or 0 }}</span>
                </div>
            </div>

            <div class="d-flex flex-wrap gap-3 mt-4">
                <a href="{{ url_for('show_reviews_student', student_id=student._id|string) }}"
                   class="btn btn-outline-primary flex-grow-1">
                    <i class="bi bi-eye"></i> PerÅ¾iÅ«rÄ—ti atsiliepimus
                </a>
                <a href="{{ url_for('add_new_review_student', student_id=student._id|string) }}"
                   class="btn btn-outline-success flex-grow-1">
                    <i class="bi bi-pencil-square"></i> Palikti atsiliepimÄ…
                </a>

                <a href="{{ url_for('payment_student', student_id=student._id|string) }}"
                   class="btn btn-outline-success flex-grow-1">
                    <i class="bi bi-credit-card"></i> Atlikti mokÄ—jimÄ…
                </a>

                {% if session.session_type == 'admin' %}
                <a href="{{ url_for('admin_messages_by_sender', role='student', user_id=student._id) }}"
                   class="btn btn-outline-warning flex-grow-1">
                    <i class="bi bi-chat-text"></i> PerÅ¾iÅ«rÄ—ti Å¾inutes
                </a>
                <a href="{{ url_for('admin_payments_by_sender', role='student', user_id=student._id) }}"
                   class="btn btn-outline-warning flex-grow-1">
                    <i class="bi bi-wallet2"></i> PerÅ¾iÅ«rÄ—ti mokÄ—jimus
                </a>
                {% elif session.session_type == 'student' %}
                <a href="{{ url_for('student_payments', student_id = student._id) }}"
                   class="btn btn-outline-warning flex-grow-1">
                    <i class="bi bi-wallet2"></i> PerÅ¾iÅ«rÄ—ti mokÄ—jimus
                </a>
                <a href="{{ url_for('friends', student_id = student._id) }}"
                   class="btn btn-outline-secondary flex-grow-1">
                    <i class="bi bi-people"></i> Draugai
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Rasti korepetitorius per draugu tinklÄ… -->
<h3 class="mb-3 fw-bold text-success">Rasti korepetitorius per draugÅ³ tinklÄ…</h3>

<form method="get" class="row g-3 mb-4">
    <div class="col-md-6">
        <label class="form-label fw-semibold">Pasirinkite dalykÄ…:</label>
        <select name="subject" class="form-select" onchange="this.form.submit()">
            <option value="">-- Pasirinkite --</option>
            {% for subj in available_subjects %}
                <option value="{{ subj }}" {% if selected_subject == subj %}selected{% endif %}>
                    {{ subj }}
                </option>
            {% endfor %}
        </select>
    </div>
</form>

{% if selected_subject %}
    <h5 class="mb-2">Rezultatai dalykui: <strong>{{ selected_subject }}</strong></h5>

    {% if graph_tutors %}
        <div class="row g-4 mb-5">
            {% for tutor in graph_tutors %}
                <div class="col-md-6 col-lg-4">
                    <div class="card shadow-sm border-0 rounded-3 p-3 h-100">
                        <h5 class="card-title">{{ tutor.first_name }} {{ tutor.last_name }}</h5>
                        <p class="mb-1"><strong>Trumpiausias kelias:</strong> {{ tutor.path_length }}</p>
                        <p class="mb-1"><strong>Kelias:</strong> {{ tutor.path | join(" â†’ ") }}</p>
                        {% if session.session_type == 'admin' %}
                        <a href="{{ url_for('add_student_to_tutor',
                                            tutor_id=tutor.tutor_id,
                                            student_id=student._id|string) }}"
                           class="btn btn-success btn-sm mt-3">
                            <i class="bi bi-plus-circle"></i> Priskirti mokinÄ¯
                        {% endif %}
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-muted">DraugÅ³ tinkle nerasta korepetitoriÅ³ Å¡iam dalykui.</p>
    {% endif %}
{% endif %}


                <!-- Korepetitoriai su chat mygtukais -->
        <h3 class="mb-4 fw-bold text-success">Korepetitoriai</h3>
        {% if tutors %}
            <div class="row g-4 mb-5">
                {% for tutor in tutors %}
                    <div class="col-sm-6 col-md-4 col-lg-3">
                        <div class="card h-100 shadow-sm border-0 rounded-3">
                            <div class="card-body text-center">
                                <h5 class="card-title mb-2">{{ tutor.first_name }} {{ tutor.last_name }}</h5>
                                <p class="mb-1 text-muted"><i class="bi bi-envelope"></i> {{ tutor.email }}</p>
                                <p class="mb-0"><strong>Dalykas:</strong> {{ tutor.subject }}</p>
                                <!-- Chat mygtukas su korepetitoriumi -->
                                <a href="{{ url_for('chat_with_tutor', student_id=student._id, tutor_id=tutor._id) }}"
                                   class="btn btn-outline-primary btn-sm mt-2">
                                    <i class="bi bi-chat-dots"></i> RaÅ¡yti Å¾inutÄ™
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">Mokinys Å¡iuo metu neturi priskirtÅ³ korepetitoriÅ³.</p>
        {% endif %}

        <!-- DraugÅ³ tinklo korepetitoriai -->
        {% if student.network_tutors %}
        <h3 class="mb-4 fw-bold text-info">Korepetitoriai per draugÅ³ tinklÄ… ({{ subject }})</h3>
        <div class="row g-4 mb-5">
            {% for tutor in student.network_tutors %}
            <div class="col-sm-6 col-md-4 col-lg-3">
                <div class="card h-100 shadow-sm border-0 rounded-3">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-2">{{ tutor.first_name }} {{ tutor.last_name }}</h5>
                        <p class="mb-1"><strong>Kelio ilgis:</strong> {{ tutor.path_length }}</p>
                        <p class="mb-0"><strong>Pavyzdinis kelias:</strong> {{ tutor.path | join(' â†’ ') }}</p>

                        <!-- Changed: Assign Student Button -->
                        <a href="{{ url_for('add_student_to_tutor',
                                            tutor_id=tutor._id|string,
                                            student_id=student._id|string) }}"
                           class="btn btn-success btn-sm mt-2">
                            <i class="bi bi-plus-circle"></i> Priskirti mokinÄ¯
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Pamokos -->
        <h3 class="mb-4 fw-bold text-success">Pamokos</h3>
        {% if lessons %}
            <div class="row g-3">
                {% for lesson in lessons %}
                    <div class="col-md-6 col-lg-4">
                        <div class="card shadow-sm border-0 rounded-3 p-3 h-100">
                            <p class="mb-2"><strong>ğŸ•’ Data:</strong> {{ lesson.time }}</p>
                            <p class="mb-2"><strong>ğŸ‘¨â€ğŸ« Korepetitorius:</strong> {{ lesson.tutor_first_name }} {{ lesson.tutor_last_name }}</p>
                            <p class="mb-0"><strong>ğŸ‘©â€ğŸ“ Mokiniai:</strong>
                                {% for s in lesson.students %}
                                    {{ s.first_name }} {{ s.last_name }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">Mokinys Å¡iuo metu neturi suplanuotÅ³ pamokÅ³.</p>
        {% endif %}

    {% else %}
        <p class="text-muted">Mokinys nerastas.</p>
    {% endif %}

</div>

<style>
.btn-outline-primary { border-width: 2px; }
.btn-outline-success { border-width: 2px; }
.card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
.card:hover { transform: translateY(-4px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock %}
