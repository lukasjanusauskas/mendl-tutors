{% extends "base.html" %}

{% block title %}Pokalbis su {{ student.first_name }}{% endblock %}

{% block content %}
<div class="container py-5">

    {% if tutor and student %}
        <h3 class="mb-4">Pokalbis: {{ tutor.first_name }} {{ tutor.last_name }} ↔ {{ student.first_name }} {{ student.last_name }}</h3>


        <div id="chat-box" class="card border-0 shadow-sm rounded-3 p-4 mb-4" style="height: 300px; overflow-y: auto;">
            <p class="text-muted text-center mt-5">Čia ateityje bus rodomos žinutės.</p>
        </div>


        <div class="d-flex gap-2">
            <input type="text" id="msg-input" class="form-control" placeholder="Rašykite žinutę...">
            <button class="btn btn-primary" type="button" onclick="sendMessage()">
                <i class="bi bi-send"></i> Siųsti
            </button>
        </div>


        {% if sender_role == 'tutor' %}
            <a href="{{ url_for('view_tutor', tutor_id=tutor._id) }}" class="btn btn-outline-secondary mt-3">
                <i class="bi bi-arrow-left"></i> Grįžti
            </a>
        {% else %}
            <a href="{{ url_for('view_student', student_id=student._id) }}" class="btn btn-outline-secondary mt-3">
                <i class="bi bi-arrow-left"></i> Grįžti
            </a>
        {% endif %}

    {% else %}
        <p class="text-muted">Korepetitorius arba mokinys nerastas.</p>
    {% endif %}

</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const socket = io();
const tutor_id = "{{ tutor._id }}";
const student_id = "{{ student._id }}";
const sender_role = "{{ sender_role }}";

const chatBox = document.getElementById("chat-box");
const msgInput = document.getElementById("msg-input");


function appendMessage(sender, message, timestamp=null) {
    const div = document.createElement("div");
    div.className = sender === sender_role ? "text-end mb-2" : "text-start mb-2";
    const timeText = timestamp ? ` (${new Date(timestamp).toLocaleTimeString()})` : "";
    div.textContent = `${sender}: ${message}${timeText}`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}


socket.emit("join", {tutor_id, student_id});

socket.on("load_messages", (messages) => {
    chatBox.innerHTML = "";
    messages.reverse().forEach(m => appendMessage(m.sender, m.message, m.timestamp));
});


socket.on("receive_message", (m) => {
    appendMessage(m.sender, m.message, m.timestamp);
});


function sendMessage() {
    const message = msgInput.value.trim();
    if (!message) return;
    socket.emit("send_message", {tutor_id, student_id, sender: sender_role, message});
    msgInput.value = "";
}
</script>

{% endblock %}
